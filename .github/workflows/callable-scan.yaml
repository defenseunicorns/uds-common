# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

name: Callable-Scan

on:
  workflow_call:
    inputs:
      udsCliVersion:
        description: The uds-cli version to install
        # renovate: datasource=github-tags depName=defenseunicorns/uds-cli versioning=semver
        default: 0.22.0
        type: string
      zarfYamlPath:
        description: The path to the zarf.yaml file
        default: zarf.yaml
        type: string

# Permissions for the GITHUB_TOKEN used by the workflow.
permissions:
  contents: read # Allows reading the content of the repository.
  packages: read # Allows reading the content of the repository's packages.
  id-token: write
  security-events: write
  actions: read

# Abort prior jobs in the same workflow / PR
concurrency:
  group: scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  get-image-list:
    runs-on: ubuntu-latest
    outputs:
      image_name_list: ${{ steps.get-image-list.outputs.image_name_list }}
      image_list: ${{ steps.get-image-list.outputs.image_list }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install UDS CLI
        uses: defenseunicorns/setup-uds@ab842abcad1f7a3305c2538e3dd1950d0daacfa5 # v1.0.1
        with:
          version: v${{ inputs.udsCliVersion }}

      - name: Get image list from zarf.yaml
        id: get-image-list
        run: |
          IMAGE_NAME_LIST=$(uds zarf tools yq -r -o=json -I=0 '[.components.[].images] | flatten | unique | . |= map(select((test(".sig") | not) and (test(".att") | not)) | split(":")[0])'  ${{ inputs.zarfYamlPath }})
          IMAGE_LIST=$(uds zarf tools yq -r -o=json -I=0 '[.components.[].images] | flatten | unique | . |= map(select((test(".sig") | not) and (test(".att") | not)) | {"name": split(":")[0], "tag": split(":")[1]})' ${{ inputs.zarfYamlPath }})
          echo "image_name_list=$IMAGE_NAME_LIST" >> "$GITHUB_OUTPUT"
          echo "image_list=$IMAGE_LIST" >> "$GITHUB_OUTPUT"

  scan-images:
    needs: get-image-list
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.get-image-list.outputs.image_name_list) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install UDS CLI
        uses: defenseunicorns/setup-uds@ab842abcad1f7a3305c2538e3dd1950d0daacfa5 # v1.0.1
        with:
          version: v${{ inputs.udsCliVersion }}

      - name: Environment setup
        run: |
            uds run actions:setup-environment \
            --set REGISTRY1_USERNAME="${{ secrets.IRON_BANK_ROBOT_USERNAME }}" \
            --set REGISTRY1_PASSWORD="${{ secrets.IRON_BANK_ROBOT_PASSWORD }}" \
            --set GH_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            --set CHAINGUARD_IDENTITY="${{ secrets.CHAINGUARD_IDENTITY }}"
        shell: bash

      - name: Get full image
        id: get-image
        run: |
          echo "image=${{ matrix.image }}:$(echo '${{ needs.get-image-list.outputs.image_list }}' | yq -r '.[] | select(.name == "${{ matrix.image }}") | .tag')" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Scan image
        id: scan
        uses: anchore/scan-action@v6.1.0
        with:
          image: ${{ steps.get-image.outputs.image }}
          fail-build: false

      - name: Post Process SARIF
        shell: bash
        run: |
          # Find the line number of the image in the zarf.yaml file
          location=$(grep -n -o '[^\w/-]${{ matrix.image }}:' "${{ inputs.zarfYamlPath }}" | head -n 1)

          if [ -z "$location" ]; then
            echo "String not found"
            exit 1
          fi

          line_number=$(echo "$location" | cut -d: -f1)
          end_column=$(grep '[^\w/]${{ matrix.image }}:' zarf.yaml | wc -m)

          # Create new physicalLocation json object
          NEW_LOCATION=$(jq -n --arg line_number "$line_number" --arg end_column "$end_column" '
          {
            "artifactLocation": {
              "uri": "${{ inputs.zarfYamlPath }}"
            },
            region: {
              startLine: $line_number | tonumber,
              startColumn: 1 | tonumber,
              endLine: $line_number | tonumber,
              endColumn: $end_column | tonumber
            }
          }
          ')

          # Create new sarif file with modified physicalLocation
          jq ".runs[].results[].locations[].physicalLocation = ${NEW_LOCATION}" ${{ steps.scan.outputs.sarif }} | sed 's/&/\\u0026/g' | sed 's/>/\\u003e/g' > ${{ steps.scan.outputs.sarif }}.new

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}.new
