name: Test
description: Test the UDS package

inputs:
  flavor:
    description: Flavor of the package to test
    required: true
  type:
    description: Whether to run upgrade tests
    default: install
  options:
    description: Additional CLI options for test workflows
    default: ""

runs:
  using: composite
  steps:
    - name: Get latest tag
      shell: bash
      id: get_tag
      run: |
        git fetch --tags
        LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_ENV

    - name: Get Repo Url
      shell: bash
      id: get_repo_url
      run: |
        REPO_URL=${{ github.server_url }}/${{ github.repository }}
        echo "repo_url=$REPO_URL" >> $GITHUB_ENV

    # === INSTALL TESTING ===

    - name: Test installing the package
      if: ${{ inputs.type == 'install' }}
      run: uds run test-package --set FLAVOR=${{ inputs.flavor }} --set LATEST_TAG=${{ env.latest_tag }} --set REPO_URL=${{ env.repo_url }} ${{ inputs.options }} --no-progress
      shell: bash

    # === UPGRADE TESTING ===

    - name: Test upgrading the package
      if: ${{ inputs.type == 'upgrade' }}
      run: uds run test-upgrade --set FLAVOR=${{ inputs.flavor }} --set LATEST_TAG=${{ env.latest_tag }} --set REPO_URL=${{ env.repo_url }} ${{ inputs.options }} --no-progress
      shell: bash
