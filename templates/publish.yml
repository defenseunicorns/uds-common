# templates/publish.yaml
publish:
  script:
    # Environment setup
    - uds run actions:setup-environment \
        --set REGISTRY1_USERNAME="${IRON_BANK_ROBOT_USERNAME}" \
        --set REGISTRY1_PASSWORD="${IRON_BANK_ROBOT_PASSWORD}" \
        --set GH_TOKEN="${GITHUB_TOKEN}" \
        --set CHAINGUARD_IDENTITY="${CHAINGUARD_IDENTITY}"

    # Publish Package
    - uds run publish-package --set FLAVOR="${FLAVOR}" --no-progress

  after_script:
    # Save logs, which will run even if the script section fails
    - uds run actions:save-logs

  artifacts:
    when: always
    paths:
      # Save debug logs as artifacts
      - /tmp/zarf-*.log
      - /tmp/uds-*.log
      - /tmp/maru-*.log
      - /tmp/debug-*.log
      - /tmp/uds-containerd-logs
      - /tmp/k3d-uds-*.log
      - oscal-assessment-results.yaml

      # Include reports-path as regular artifacts
      - $REPORTS_PATH

    name: ${REPORTS_NAME}-${FLAVOR}-${CI_PIPELINE_ID}-${CI_JOB_ID}

# todo fix publish rules
  rules:
    - if: $CI_COMMIT_REF_NAME == "main"  # Adjust this condition as needed

#todo these should be inputs instead of variables
  variables:
    FLAVOR: ${FLAVOR}
    REPORTS_PATH: ${REPORTS_PATH:-}
    REPORTS_NAME: ${REPORTS_NAME:-playwright-report}
