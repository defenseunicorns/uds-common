spec:
  inputs:
    runsOn:
      default: uds
    flavor:
    type:
    reports-path:
      default: ""
    reports-name:
      default: playwright-report
    registry1Username:
      default: ${IRON_BANK_ROBOT_USERNAME}
    registry1Password:
      default: ${IRON_BANK_ROBOT_PASSWORD}
    chainguardIdentity:
      default: ${CHAINGUARD_IDENTITY}
---
test:
  id_tokens:
    CHAINGUARD_TOKEN:
      aud: https://console-api.enforce.dev
  #TODO rules update for upgrade check / flavor stuff
  rules:
    - if: $CI_MERGE_REQUEST_ID
  script:
    #TODO need to do actions:authenticate-registries here when we get secrets

    #note: was trying this stuff to see how to get chainguard login working, commented out for now because it doesn't seem to get identity token
    # - mkdir ~/bin
    # - export PATH=~/bin:$PATH
    # - |
    #   curl -o ~/bin/chainctl -L \
    #     "https://dl.enforce.dev/chainctl/latest/chainctl_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/aarch64/arm64/')" \
    #     && chmod +x ~/bin/chainctl
    - sudo ln -s /usr/local/bin/chainctl /usr/local/bin/docker-credential-cgr
    - chainctl auth login --identity "$[[ inputs.chainguardIdentity ]]" --identity-token "$CHAINGUARD_TOKEN" -v=0
    - chainctl auth configure-docker --identity "$[[ inputs.chainguardIdentity ]]" --identity-token "$CHAINGUARD_TOKEN" -v=0
    #end temporary chainguard stuff

    - uds run actions:authenticate-registries --set REGISTRY1_USERNAME="$[[ inputs.registry1Username ]]" --set REGISTRY1_PASSWORD="$[[ inputs.registry1Password ]]" #--set CHAINGUARD_IDENTITY="$[[ inputs.chainguardIdentity ]]"
    - uds run actions:test-deploy --set FLAVOR="$[[ inputs.flavor ]]" --set TYPE="$[[ inputs.type ]]"
    - uds run actions:verify-badge

  after_script:
    - uds run actions:debug-output
    - uds run actions:save-logs

    # TODO this would be better if we change debug-output and save-logs to take a directory name to write to
    # gitlab can only attach artifacts that are under the project, not arbitrary dirs on the runner
    - mkdir logs && cp /tmp/*.log logs && cp -R /tmp/uds-containerd-logs logs

  artifacts:
    when: always
    name: debug-log-$[[ inputs.type ]]-$[[ inputs.flavor ]]-${CI_PIPELINE_ID}-${CI_JOB_ID}
    paths:
      # Save debug logs as artifacts
      - logs/zarf-*.log
      - logs/uds-*.log
      - logs/maru-*.log
      - logs/debug-*.log
      - logs/uds-containerd-logs
      - logs/k3d-uds-*.log
      - oscal-assessment-results.yaml
  tags:
    - $[[ inputs.runsOn ]]
  # TODO need to figure out the report path and extra report artifact stuff too
  #      we may be able to do another "artifacts" section with a when keyed on report name/path inputs
